services:
  postgres-user:
    image: postgres:16
    container_name: family-postgres-user
    environment:
      POSTGRES_DB: ${USER_DB_NAME:-userdb}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    ports: ["5432:5432"]
    volumes:
      - pgdata_user:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${POSTGRES_USER:-postgres}", "-d", "${USER_DB_NAME:-userdb}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks: [backend]
    restart: unless-stopped

  postgres-budget:
    image: postgres:16
    container_name: family-postgres-budget
    environment:
      POSTGRES_DB: ${BUDGET_DB_NAME:-budgetdb}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    ports: ["5433:5432"]
    volumes:
      - pgdata_budget:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks: [backend]
    restart: unless-stopped

  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: family-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBIT_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBIT_PASS:-guest}
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks: [backend]
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  user-service:
    image: ${USER_IMAGE}
    container_name: family-user
    env_file: .env
    environment:
      SPRING_JPA_HIBERNATE_DDL_AUTO: "validate"

      SPRING_SQL_INIT_MODE: "never"
      SPRING_SQL_INIT_CONTINUE_ON_ERROR: "false"

      SPRING_FLYWAY_ENABLED: "false"
      SPRING_AUTOCONFIGURE_EXCLUDE: "org.springframework.boot.autoconfigure.flyway.FlywayAutoConfiguration"

      AMQP_URL: amqp://${RABBIT_USER:-guest}:${RABBIT_PASS:-guest}@rabbitmq:5672
      SPRING_DATASOURCE_HIKARI_INITIALIZATIONFAILTIMEOUT: "0"
      SPRING_RABBITMQ_CONNECTION_TIMEOUT: "60000"
      JWT_SECRET: ${JWT_SECRET}
      JWT_ISSUER: ${JWT_ISSUER:-family-budget}
      JWT_REFRESH_TOKEN_TTL_DAYS: "14"     
      JWT_ACCESS_TOKEN_TTL_MIN: "60"       
    depends_on:
      postgres-user:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    ports: ["8001:8080"]
    networks: [backend]
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  budget-service:
    image: ${BUDGET_IMAGE}
    container_name: family-budget
    env_file: .env
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DB_URL: jdbc:postgresql://postgres-budget:5432/${BUDGET_DB_NAME:-budgetdb}
      DB_USER: ${POSTGRES_USER:-postgres}
      DB_PASS: ${POSTGRES_PASSWORD:-postgres}
      AMQP_URL: amqp://${RABBIT_USER:-guest}:${RABBIT_PASS:-guest}@rabbitmq:5672
      SPRING_DATASOURCE_HIKARI_INITIALIZATIONFAILTIMEOUT: "0"
      SPRING_SQL_INIT_CONTINUE_ON_ERROR: "true"
      SPRING_RABBITMQ_CONNECTION-TIMEOUT: "60000"
    depends_on:
      postgres-budget:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    ports: ["8002:8080"]
    networks: [backend]
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  analytic-service:
    image: ${ANALYTICS_IMAGE}
    container_name: family-analytics
    env_file: .env
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DB_URL: jdbc:postgresql://postgres-budget:5432/${BUDGET_DB_NAME:-budgetdb}
      DB_USER: ${POSTGRES_USER:-postgres}
      DB_PASS: ${POSTGRES_PASSWORD:-postgres}
      AMQP_URL: amqp://${RABBIT_USER:-guest}:${RABBIT_PASS:-guest}@rabbitmq:5672
      SPRING_DATASOURCE_HIKARI_INITIALIZATIONFAILTIMEOUT: "0"
      SPRING_SQL_INIT_CONTINUE_ON_ERROR: "true"
      SPRING_RABBITMQ_CONNECTION-TIMEOUT: "60000"
    depends_on:
      postgres-budget:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    ports: ["8003:8080"]
    networks: [backend]
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  gateway:
    image: ${GATEWAY_IMAGE}
    container_name: family-gateway
    env_file: .env
    environment:
      SPRING_PROFILES_ACTIVE: docker
      USERS_URL: http://user-service:8080
      BUDGET_URL: http://budget-service:8080
      ANALYTIC_URL: http://analytic-service:8080
    depends_on:
      user-service:
        condition: service_started
      budget-service:
        condition: service_started
      analytic-service:
        condition: service_started
    ports: ["8080:8080"]
    networks: [frontend, backend]
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  prometheus:
    image: prom/prometheus
    container_name: family-prometheus
    ports: ["9090:9090"]
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    depends_on:
      user-service:
        condition: service_started
      budget-service:
        condition: service_started
      analytic-service:
        condition: service_started
    networks: [backend]
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  grafana:
    image: grafana/grafana
    container_name: family-grafana
    ports: ["3000:3000"]
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      prometheus:
        condition: service_started
    networks: [backend]
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  pgdata_user:
  pgdata_budget:
  rabbitmq_data:
  grafana_data:

networks:
  backend:
    driver: bridge
  frontend:
    driver: bridge
